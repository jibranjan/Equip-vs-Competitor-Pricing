<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="https://cdn.equip.co/static/img/favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Pricing | Equip</title>
  </head>

  <body>
    <script>
      var competitorData;
      let p = fetch(
        "https://tvw82n52.api.sanity.io/v2022-03-07/data/query/production?query=*%5B_type+%3D%3D+%22competitorPricing%22%5D"
      );
      p.then((response) => {
        return response.json();
      }).then((value) => {
        window.competitorData = value;
        populateCompetitorDropdown();
      });

      function populateCompetitorDropdown() {
        let dropdownEl = document.getElementById("competitors");

        competitorData.result.forEach(function (index) {
          if (index.label === "equip") {
            return;
          }
          let option = document.createElement("option");
          option.value = index.label;
          option.textContent = index.name;
          option.classList.add("competitor-option");
          dropdownEl.appendChild(option);
        });
      }
    </script>
    <div
      class="flex flex-col gap-10 text-xl rounded-md border-2 border-blue-900 max-w-xl mx-auto mt-40 p-2"
    >
      <div class="flex gap-10">
        <div>
          <span>Competitor:</span>
          <select name="Competitors" id="competitors">
            <option>Select Competitor</option>
            <!-- hardcoded for TestGorilla -->
            <option value="testgorilla" class="competitor-option">
              TestGorilla
            </option>
          </select>
        </div>
        <div id="testgorilla-team-size-container" class="hidden">
          <span>Team Size:</span>
          <select id="team-size">
            <!-- <option value="AMOUNT CHARGED BY TEST GORILLA IN INR">"SIZE OF TEAM"</option> -->

            <option value="67500">1 - 15</option>
            <option value="108000">16 - 30</option>
            <option value="187500">31 - 50</option>
            <option value="360000">51 - 100</option>
            <option value="630000" selected>101 - 200</option>
            <option value="1012500">201 - 300</option>
            <option value="1572000">301 - 400</option>
            <option value="2250000">401 - 500</option>
            <option value="3150000">501 - 750</option>
            <option value="3600000">751 - 1000</option>
          </select>
        </div>
      </div>
      <div>
        <span>Country:</span>
        <select id="countries">
          <option class="country" value="IN" selected="true">India</option>
          <option class="country" value="US">US</option>
        </select>
      </div>
      <div class="">
        <label class="" for="no-of-candidates">No. Of Candidates:</label>
        <input
          id="no-of-candidates"
          class="rounded-md border-2 border-emerald-500"
          type="number"
        />
      </div>
      <div class="flex gap-10">
        <div>
          <span class="inline-block mb-1">Equip:</span>
          <div
            id="output-equip"
            class="border-2 border-emerald-500 min-w-20 h-8 rounded-md"
          ></div>
        </div>
        <div>
          <span class="inline-block mb-1">Competitor:</span>
          <div
            id="output-competitor"
            class="border-2 border-emerald-500 min-w-20 h-8 rounded-md"
          ></div>
        </div>
      </div>
      <div
        id="submit-button"
        class="w-fit border text-white bg-blue-900 rounded-md py-1 px-5 cursor-pointer"
      >
        Submit
      </div>
    </div>
  </body>
  <script>
    window.addEventListener("load", () => {});
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const competitorFromParams = urlParams.get("c");

    let companyElArray = document.querySelectorAll(".competitor-option");
    companyElArray.forEach(function (companyEl) {
      let companyElValue = companyEl.getAttribute("value");
      if (competitorFromParams === companyElValue) {
        companyEl.setAttribute("selected", true);
      }
    });

    let countriesEl = document.getElementById("countries");

    countriesEl.addEventListener("change", getCountry);

    candidatesInputEl = document.getElementById("no-of-candidates");

    candidatesInputEl.addEventListener("keydown", validationNumCandidates);
    candidatesInputEl.addEventListener("paste", validationNumCandidates);

    let submitButtonEl = document.getElementById("submit-button");

    submitButtonEl.addEventListener("click", onSubmit);

    function validationNumCandidates(event) {
      let key = event.key;
      if (getNumCandidates() === "" && event.key === "0") {
        event.preventDefault();
      }
      if (key === "-" || key === "+" || key === ".") {
        event.preventDefault();
      }
      if (key === "Enter") {
        event.preventDefault();
        onSubmit();
      }
      if (event.type === "paste") {
        let pasteData = event.clipboardData.getData("text/plain");
        if (!/^\d+$/.test(pasteData) || pasteData.startsWith("0")) {
          alert("Invalid input for number of candidates");
          event.preventDefault();
        }
      }
    }

    let competitorsEl = document.getElementById("competitors");

    function getCompetitor() {
      let selectedIndex = competitorsEl.selectedIndex;
      let selectedCompetitor = competitorsEl.options[selectedIndex];
      let competitorValue = selectedCompetitor.value;
      return competitorValue;
    }

    function getCountry() {
      let selectedIndex = countriesEl.selectedIndex;
      let selectedCountry = countriesEl.options[selectedIndex];
      let countryValue = selectedCountry.value;
      return countryValue;
    }

    function getNumCandidates() {
      let numOfCandidatesEl = document.getElementById("no-of-candidates");
      return numOfCandidatesEl.value;
    }
    function getPricingModel() {
      let pricingModel;
      competitorData.result.forEach(function (index) {
        if (index.label === getCompetitor()) {
          pricingModel = index.parameters.pricingModel;
        }
      });
      return pricingModel;
    }
    // forequip
    function getEquipPrice() {
      let cost;
      competitorData.result.forEach(function (index) {
        if (index.label === "equip") {
          cost = index.parameters.costPerCandidate;
        }
      });
      return cost;
    }

    // for competitors:
    function getCompetitorPrice() {
      let cost;
      let pricingModel = getPricingModel();

      competitorData.result.forEach(function (index) {
        if (index.label === getCompetitor()) {
          if (pricingModel === "pure-usage") {
            cost = index.parameters.costPerCandidate;
          } else if (pricingModel === "pure-subscription") {
            cost = index.parameters.annualSubscriptionCost;
          } else if (pricingModel === "subscription-with-usage") {
            cost = {
              perCandidate: index.parameters.costPerCandidate,
              annual: index.parameters.annualSubscriptionCost,
            };
          }
        }
      });
      return cost;
    }

    function getNumCandidatesIncludedInSubscription() {
      let numCandInSub;
      let pricingModel = getPricingModel();

      competitorData.result.forEach(function (index) {
        if (index.label === getCompetitor()) {
          if (
            pricingModel === "subscription-with-usage" ||
            "pure-subscription"
          ) {
            numCandInSub = index.parameters.numCandidatesIncludedInSubscription;
          }
        }
      });
      return numCandInSub;
    }

    let equipOutputEl = document.getElementById("output-equip");
    function calculateEquipCost() {
      let numOfCandidates = getNumCandidates();
      let equipPrice = getEquipPrice();
      if (getCountry() === "IN") {
        equipOutputEl.innerHTML = "₹" + numOfCandidates * equipPrice.IN;
      } else if (getCountry() === "US") {
        equipOutputEl.innerHTML = "$" + numOfCandidates * equipPrice.US;
      }
    }

    let competitorOutputEl = document.getElementById("output-competitor");
    function calculateCompetitorCost() {
      let numOfCandidates = getNumCandidates();
      let pricingModel = getPricingModel();
      let competitorPrice = getCompetitorPrice(pricingModel);
      let numOfCandidatesIncludedInSub =
        getNumCandidatesIncludedInSubscription(pricingModel);
      if (pricingModel === "pure-usage") {
        if (getCountry() === "IN") {
          competitorOutputEl.innerHTML =
            "₹" + numOfCandidates * competitorPrice.IN;
        } else if (getCountry() === "US") {
          competitorOutputEl.innerHTML =
            "$" + numOfCandidates * competitorPrice.US;
        }
      } else if (pricingModel === "pure-subscription") {
        if (getCountry() === "IN") {
          if (numOfCandidates <= numOfCandidatesIncludedInSub) {
            competitorOutputEl.innerHTML = "₹" + competitorPrice.IN;
          } else {
            let totalCost =
              competitorPrice.IN *
              Math.ceil(numOfCandidates / numOfCandidatesIncludedInSub);
            competitorOutputEl.innerHTML = "₹" + totalCost;
          }
        } else if (getCountry() === "US") {
          if (numOfCandidates <= numOfCandidatesIncludedInSub) {
            competitorOutputEl.innerHTML = "$" + competitorPrice.US;
          } else {
            let totalCost =
              competitorPrice.US *
              Math.ceil(numOfCandidates / numOfCandidatesIncludedInSub);
            competitorOutputEl.innerHTML = "$" + totalCost;
          }
        }
      } else if (pricingModel === "subscription-with-usage") {
        if (getCountry() === "IN") {
          if (numOfCandidates <= numOfCandidatesIncludedInSub) {
            competitorOutputEl.innerHTML = "₹" + competitorPrice.annual.IN;
          } else {
            let totalCost =
              competitorPrice.annual.IN +
              competitorPrice.perCandidate.IN *
                (numOfCandidates - numOfCandidatesIncludedInSub);
            competitorOutputEl.innerHTML = "₹" + totalCost;
          }
        } else if (getCountry() === "US") {
          if (numOfCandidates <= numOfCandidatesIncludedInSub) {
            competitorOutputEl.innerHTML = "$" + competitorPrice.annual.US;
          } else {
            let totalCost =
              competitorPrice.annual.US +
              competitorPrice.perCandidate.US *
                (numOfCandidates - numOfCandidatesIncludedInSub);
            competitorOutputEl.innerHTML = "$" + totalCost;
          }
        }
      }
    }

    function calculateTestGorillaCost() {
      let numOfCandidates = getNumCandidates();
      let priceForTeamSize = document.getElementById("team-size").value;
      if (getCountry() === "IN") {
        competitorOutputEl.innerHTML = "₹" + priceForTeamSize;
      } else if (getCountry() === "US") {
        competitorOutputEl.innerHTML = "$" + Math.floor(priceForTeamSize / 82);
      }
    }

    competitorsEl.addEventListener("change", function () {
      hideTeamSize();
    });

    let testGorillaTeamSizeContainerEl = document.getElementById(
      "testgorilla-team-size-container"
    );
    function hideTeamSize() {
      competitorData.result.forEach(function (index) {
        if (getCompetitor() === "testgorilla") {
          testGorillaTeamSizeContainerEl.classList.remove("hidden");
        } else if (getCompetitor() !== "testgorilla") {
          testGorillaTeamSizeContainerEl.classList.add("hidden");
        }
      });
    }

    function onSubmit() {
      if (getCompetitor() === "testgorilla") {
        calculateTestGorillaCost();
      } else {
        calculateCompetitorCost();
      }
      calculateEquipCost();
    }
  </script>
</html>
